<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" typ="text/css" href="./style.css">
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"></script>
  </head>
  <body>
    <h1>
      <strong>
        <em>Twiddler</em>
      </strong>
    </h1>
    <div>
      <button class="btn-main">Post!</button>
    </div>

    <div class="feed"></div>

    <script>
      $(document).ready(function(){
        var $feed = $('.feed');
        let paused = false;
        let userName = '';

        $feed.html('');

        getTweets(userName);
        setEventHandlers();

        setInterval(function() {
          if (!paused) {
            getTweets(userName);
            setEventHandlers();
          }

        }, 10000);

        function getTweets(userName) {
          var strCollection = userName ? streams.users[userName]: streams.home;
          var index = strCollection.length - 1;

          $('.feed').empty(); //clear items before updating date
          while (index >= 0){
            var tweet = strCollection[index];
            var $tweet = $('<div class="tweet-block"></div>');
            var date = tweet.created_at.toISOString(); //this is a suitable format for moment
            var $twitTime = $(`<p class="tweet-time">&nbsp  - ${moment(date).fromNow()}</p>`); //this gets us 'twitter time'

            $tweet.html(`<button href="#" class=${tweet.user}>@${tweet.user}</button><p class="tweet">&nbsp-- ${tweet.message}</p>`);

            $tweet.appendTo($feed);
            $twitTime.appendTo($tweet);
            $(`.${tweet.user}`).addClass('btn-user');
            index -= 1;
          }
        }

        function handleClick(e) {
          if (e.target.classList[0] === 'btn-main') {
            if (!userName) {
              handlePost();
            } else {
              userName = '';
              getTweets(userName);
              $('.btn-main').text('Post!');
            }
          } else {
            userName = e.target.classList[0];
            getTweets(userName);
            $('.btn-main').text('< Back');
          }


        }

        function handlePost() {
          $('.feed').empty();
          paused = true;
          $('.btn-main').text('Submit');

        }

        function setEventHandlers() {
          $('.feed, .btn-main').on('click', handleClick);
        }
      });
    </script>
  </body>
</html>
