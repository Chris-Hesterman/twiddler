<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" typ="text/css" href="./style.css">
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"></script>
  </head>
  <body>
    <header>
      <h1>
        <strong>
          <em>Twiddler</em>
        </strong>
      </h1>
      <div class="control">
        <button class="btn-main">&ltBack</button>
        <form class="form user-info">
          <input type="text" class="form user-name-input" placeholder="Name..." autofocus required>
          <input type="text" class="form user-message-input" placeholder="Message..." required>
          <button type="submit" class="form submit">POST</button>
        </form>
      </div>
    </header>


    <main class="feed"></main>

    <script>
      $(document).ready(function(){
        let $feed = $('.feed');
        let userName = '';

        getTweets(userName);
        $('.btn-main').on('click', handleMainClick);

        setInterval(function() {
            getTweets(userName);
        }, 10000);

        function getTweets(userName) {
          const strCollection = userName ? streams.users[userName]: streams.home;
          let index = strCollection.length - 1;

          $('.feed').empty(); //clear items before refreshing

          while (index >= 0){
            let tweet = strCollection[index];
            const date = tweet.created_at.toISOString();  //this is a suitable format for moment.js to work with
            const $tweet = $('<div class="tweet-block"></div>');
            const $twitTime = $(`<p class="tweet-time">&nbsp  - ${moment(date).fromNow()}</p>`);   //this gets us 'twitter time'

            $tweet.html(`<button class=${tweet.user}>@${tweet.user}</button><p class="tweet">&nbsp-- ${tweet.message}</p><span class="spacer"> <span>`);
            $tweet.appendTo($feed);
            $twitTime.appendTo($tweet);
            $(`.${tweet.user}`).addClass('btn-user');
            index -= 1;
          }
          // Since users keep getting refreshed, using jQuery 'one()' to attach
          // event listener, fire it only once then remove itself.
          $('.btn-user').one('click', handleUserClick);
        }

        function handleUserClick(e) {
          userName = e.target.classList[0];
          getTweets(userName);
          $('.form').css('visibility', 'hidden');
          $('.control').css('justify-content', 'flex-start');
          $('.btn-main').show();
          console.log(e.target.classList)
        }

        function handleMainClick(e) {
          if (userName) {
            userName = '';
            getTweets(userName);
            $('.form').css('visibility', 'visible');
            $('.control').css('justify-content', 'center');
            $('.btn-main').hide();
          } else {

          }
          console.log('Main');
        }
      });
    </script>
  </body>
</html>
